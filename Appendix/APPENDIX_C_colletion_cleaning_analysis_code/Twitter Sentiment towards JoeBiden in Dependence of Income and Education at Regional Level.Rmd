---
title: Twitter Sentiment towards Joe Biden in Dependence of Income and Education at
  Regional Level
author: "Priyanka Chaudhary, Florian Ettinger, Daniel Kwasnitschka, Dario Peier"
---

This File contains the necessary code to replicate the results presented in “Twitter Sentiment towards Joe Biden in Dependence of Income and Education at Regional Level” by Priyanka Chaudhary, Florian Ettinger, Daniel Kwasnitschka, Dario Peier

Setup
```{r}
install.packages("rtweet")
install.packages("httpuv")
install.packages("maps")
install.packages("ggmap")
install.packages("tidyverse")
install.packages("tidycensus")
install.packages("openintro")
install.packages("syuzhet")
install.packages("vader")
```


```{r}
library(rtweet)
library(rtweet)
library(dplyr)
library(maps)
library(ggmap)
library(tidycensus)
library(tidyverse)
library(openintro)
library(syuzhet)
library(vader)
```


Note: Since the data collection and cleaning part requires API keys and takes some time until enough tweets have been collected, we have added the cleaned and formatted data  we used for our analysis to our github folder. By importing this data the data collection and cleaning code in this markdown file can be skipped and one can start right away with the analysis down below.


#Collecting and cleaning the data

##Tweet collection/cleaning

Download recent Tweets about Joe Biden using rtweet
```{r}
tweets <- search_tweets(q ="biden OR joebiden", lang = "en" , geocode = lookup_coords("usa"), n=300000, include_rts = FALSE, retryonratelimit = TRUE)
```

Add the latitudinal and longitudinal data, drop unnecessary columns and rows that carry no geolocation information 
```{r}
tweets <- lat_lng(tweets) %>% select(user_id,status_id,created_at,text,lat,lng)%>% filter(!is.na(lat))
```

With the help of the Google Maps API translate the latitudinal and longitudinal information into an adress to select the zip code and the state
```{r}
for (i in 1:nrow(tweets)) {
  tweets$location[i] = revgeocode(c(tweets$lng[i],tweets$lat[i]))
  adress = strsplit(tweets_cleaned$Location[i], ", ")[[1]]
  tweets$country[i] = adress[4]
  tweets$zip[i] = strsplit(adress[3], " ")[[1]][2]
  tweets$state[i] = strsplit(adress[3], " ")[[1]][1]
}

```
Removing any tweets outside the US and reducing the number of tweets per person to one
```{r}
tweets <- tweets %>% filter(country == "USA") %>% distinct(user_id, .keep_all = TRUE)
```

Visualize the location of tweets selected on a map of the USA
```{r}
par(mar = c(0, 0, 0, 0))
maps::map("state", lwd = .25)
## plot lat and lng points onto state map
with(tweets, points(lng, lat, pch = 20, cex = .75, col = rgb(0, .3, .7, .5)))
```


calculate sentiment
```{r}
tweets$VADER <- vader_df(tweets$text)$compound
tweets$Syuzhet <- get_sentiment(tweets$text)
```


calculate mean sentiment on zip code and state level
```{r}
aggregation_zip_lvl = tweets %>% group_by(zip) %>%
    summarise(meanVader = mean(VADER, na.rm = TRUE),meanSyuzhet = mean(Syuzhet, na.rm = TRUE)) 

aggregation_state_lvl = tweets %>% group_by(state) %>%
    summarise(meanVader = mean(VADER, na.rm = TRUE),meanSyuzhet = mean(Syuzhet, na.rm = TRUE)) 
aggregation_state_lvl$state = abbr2state(aggregation_state_lvl$state)
```





##Census data collection/cleaning

collecting income information zip code level
```{r}
income_zip <- get_acs(geography = "zcta", variables = "B06011_001", year = 2019) %>% select(-c(NAME,variable,moe)) %>%  rename(MedianIncomePast12Months = estimate,zip = GEOID)
```



collecting income information state level
```{r}
income_state <- get_acs(geography = "state", variables = "B06011_001", year = 2019 ) %>%       select(-c(GEOID,variable,moe)) %>% rename(MedianIncomePast12Months = estimate,state = NAME)
```




collecting education information zip code level and transforming absolute values to percent
```{r}
total_zip<- get_acs(geography = "zcta", variables = "B16010_001", year = 2019)%>% 
  rename( EducationTotal = estimate,zip = GEOID) %>% select(-c(NAME,variable,moe))



LessThanHighSchoolGraduate_zip<- get_acs(geography = "zcta", variables = "B16010_002", year = 2019)%>% 
  rename( LessThanHighSchoolGraduate = estimate,zip = GEOID) %>% select(-c(NAME,variable,moe))
LessThanHighSchoolGraduate_zip$LessThanHighSchoolGraduate = LessThanHighSchoolGraduate_zip$LessThanHighSchoolGraduate / total_zip$EducationTotal


HighSchoolGraduate_zip<- get_acs(geography = "zcta", variables = "B16010_015", year = 2019)%>% 
  rename(HighSchoolGraduate = estimate,zip = GEOID) %>% select(-c(NAME,variable,moe))
HighSchoolGraduate_zip$HighSchoolGraduate = HighSchoolGraduate_zip$HighSchoolGraduate / total_zip$EducationTotal


BachelorsDegreeOrHigher_zip<- get_acs(geography = "zcta", variables = "B16010_041", year = 2019)%>% 
  rename(BachelorsDegreeOrHigher = estimate,zip = GEOID)%>%select(-c(NAME,variable,moe))
BachelorsDegreeOrHigher_zip$BachelorsDegreeOrHigher = BachelorsDegreeOrHigher_zip$BachelorsDegreeOrHigher / total_zip$EducationTotal
```



collecting education information state level and transforming absolute values to percent
```{r}
total_state<- get_acs(geography = "state", variables = "B16010_001", year = 2019)%>% 
  rename( EducationTotal = estimate) %>% select(-c(GEOID,variable,moe))


LessThanHighSchoolGraduate_state<- get_acs(geography = "state", variables = "B16010_002", year = 2019)%>% 
  rename( LessThanHighSchoolGraduate = estimate) %>% select(-c(GEOID,variable,moe))
LessThanHighSchoolGraduate_state$LessThanHighSchoolGraduate = LessThanHighSchoolGraduate_state$LessThanHighSchoolGraduate / total_state$EducationTotal


HighSchoolGraduate_state<- get_acs(geography = "state", variables = "B16010_015", year = 2019)%>% 
  rename(HighSchoolGraduate = estimate) %>% select(-c(GEOID,variable,moe))
HighSchoolGraduate_state$HighSchoolGraduate = HighSchoolGraduate_state$HighSchoolGraduate / total_state$EducationTotal


BachelorsDegreeOrHigher_state<- get_acs(geography = "state", variables = "B16010_041", year = 2019)%>% 
  rename(BachelorsDegreeOrHigher = estimate)%>%select(-c(GEOID,variable,moe))
BachelorsDegreeOrHigher_state$BachelorsDegreeOrHigher = BachelorsDegreeOrHigher_state$BachelorsDegreeOrHigher / total_state$EducationTotal
```

Joining the census data on a zip level into one dataframe
```{r} 
census_data_zip = inner_join(income_zip,LessThanHighSchoolGraduate_zip,by=c("zip"="zip")) %>% inner_join(HighSchoolGraduate_zip,by=c("zip"="zip"))%>%
  inner_join(BachelorsDegreeOrHigher_zip,by=c("zip"="zip"))
```


Joining the census data and the percentage that voted for the democrats on a state level into one dataframe
```{r} 
census_data_state = inner_join(income_state,LessThanHighSchoolGraduate_state,by=c("state"="NAME")) %>% inner_join(HighSchoolGraduate_state,by=c("state"="NAME"))%>%
  inner_join(BachelorsDegreeOrHigher_state,by=c("state"="NAME"))#%>%
 # inner_join(DemocratsPercentage_state,by=c("state"="NAME"))
```

Joining sentiment and census data in final dataframe to be used for the analysis
```{r}
aggregation_zip_lvl = inner_join(aggregation_zip_lvl,census_data_zip,by=c("zip"="zip"))

aggregation_state_lvl = inner_join(aggregation_state_lvl,census_data_state,by=c("state"="state"))
```




########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################







#Analysis
Note: Since the data collection requires API keys and takes some time until enough tweets have been collected, we have added the cleaned and formatted data we used for our analysis.

When importing this data the above code can be skipped.
```{r}
aggregation_state_lvl = read.csv("aggregation_state_lvl.csv",sep = ";",header = TRUE)
aggregation_zip_lvl = read.csv("aggregation_zip_lvl.csv",sep = ";",header = TRUE)
```



The following analysis will make use of the Syuzhet scores and census data on a state level to perform the analysis

```{r}
model <- lm(meanSyuzhet ~ MedianIncomePast12Months, aggregation_state_lvl)

plot(aggregation_state_lvl$MedianIncomePast12Months,aggregation_state_lvl$meanSyuzhet, xlab="MedianIncomePast12Months", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_state_lvl$MedianIncomePast12Months,aggregation_state_lvl$meanSyuzhet)
```


```{r}
model <- lm(meanSyuzhet ~ LessThanHighSchoolGraduate, aggregation_state_lvl)

plot(aggregation_state_lvl$LessThanHighSchoolGraduate,aggregation_state_lvl$meanSyuzhet, xlab="LessThanHighSchoolGraduate", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_state_lvl$LessThanHighSchoolGraduate,aggregation_state_lvl$meanSyuzhet)
```

```{r}
model <- lm(meanSyuzhet~HighSchoolGraduate, aggregation_state_lvl)

plot(aggregation_state_lvl$HighSchoolGraduate,aggregation_state_lvl$meanSyuzhet, xlab="% of state population with high school degree", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_state_lvl$HighSchoolGraduate,aggregation_state_lvl$meanSyuzhet)
```

```{r}
model <- lm(meanSyuzhet~BachelorsDegreeOrHigher, aggregation_state_lvl)

plot(aggregation_state_lvl$BachelorsDegreeOrHigher,aggregation_state_lvl$meanSyuzhet, xlab="BachelorsDegreeOrHigher", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_state_lvl$BachelorsDegreeOrHigher,aggregation_state_lvl$meanSyuzhet)
```

```{r}
model <- lm(meanSyuzhet~PercentDemocrat, aggregation_state_lvl)

plot(aggregation_state_lvl$PercentDemocrat,aggregation_state_lvl$meanSyuzhet, xlab="PercentDemocrat", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_state_lvl$PercentDemocrat,aggregation_state_lvl$meanSyuzhet)
```

```{r}
model <- lm(meanSyuzhet~MedianIncomePast12Months + LessThanHighSchoolGraduate + HighSchoolGraduate + BachelorsDegreeOrHigher + PercentDemocrat, aggregation_state_lvl)
summary(model)
```








The following analysis will make use of the Syuzhet scores and census data on a zip code level to perform the analysis

```{r}
model <- lm(meanSyuzhet ~ MedianIncomePast12Months, aggregation_zip_lvl)

plot(aggregation_zip_lvl$MedianIncomePast12Months,aggregation_zip_lvl$meanSyuzhet, xlab="MedianIncomePast12Months", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_zip_lvl$MedianIncomePast12Months,aggregation_zip_lvl$meanSyuzhet)
```



```{r}
model <- lm(meanSyuzhet ~ LessThanHighSchoolGraduate, aggregation_zip_lvl)

plot(aggregation_zip_lvl$LessThanHighSchoolGraduate,aggregation_zip_lvl$meanSyuzhet, xlab="LessThanHighSchoolGraduate", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_zip_lvl$LessThanHighSchoolGraduate,aggregation_zip_lvl$meanSyuzhet)
```

```{r}
model <- lm(meanSyuzhet~HighSchoolGraduate, aggregation_zip_lvl)

plot(aggregation_zip_lvl$HighSchoolGraduate,aggregation_zip_lvl$meanSyuzhet, xlab="% of state population with high school degree", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_zip_lvl$HighSchoolGraduate,aggregation_zip_lvl$meanSyuzhet)
```

```{r}
model <- lm(meanSyuzhet~BachelorsDegreeOrHigher, aggregation_zip_lvl)

plot(aggregation_zip_lvl$BachelorsDegreeOrHigher,aggregation_zip_lvl$meanSyuzhet, xlab="BachelorsDegreeOrHigher", ylab="mean syuzhet score")
abline(model$coefficients[1], model$coefficients[2], col="red")

cor.test(aggregation_zip_lvl$BachelorsDegreeOrHigher,aggregation_zip_lvl$meanSyuzhet)
```
```{r}
model <- lm(meanSyuzhet~MedianIncomePast12Months + LessThanHighSchoolGraduate + HighSchoolGraduate + BachelorsDegreeOrHigher, aggregation_zip_lvl)
summary(model)
```


